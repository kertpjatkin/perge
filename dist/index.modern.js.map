{"version":3,"file":"index.modern.js","sources":["../src/index.ts"],"sourcesContent":["import Peer from 'peerjs'\nimport { init, Connection, DocSet, Doc, ChangeFn, DocSetHandler, change, undo, redo } from 'automerge'\n\ntype AutomergeUpdateMethod = typeof change | typeof undo | typeof redo\n\nexport interface PergeConfig {\n  decode?: (msg: string) => any\n  encode?: (msg: any) => string\n  peer?: Peer\n  docSet?: DocSet<any>\n}\n\nexport default class Perge {\n  readonly peer: Peer\n  readonly docSet: DocSet<any>\n\n  private _connections: { [id: string]: Connection<any> } = {}\n  private _actorId: string\n  private _encode: (msg: any) => string\n  private _decode: (msg: string) => any\n\n  constructor(actorId: string, config: PergeConfig = {}) {\n    this._actorId = actorId\n    this.peer = config.peer || new Peer(this._actorId)\n    this.docSet = config.docSet || new DocSet()\n    this._encode = config.encode || JSON.stringify\n    this._decode = config.decode || JSON.parse\n    this.peer.on('connection', conn => {\n      if(!this._connections[conn.peer]) this.connect(conn.peer)\n      conn.on('data', msg => {\n        this._connections[conn.peer].receiveMsg(this._decode(msg))\n      })\n    })\n  }\n\n  public connect(id: string, conn?: Peer.DataConnection): Peer.DataConnection {\n    if (this._connections[id]) return this.peer.connections[id]\n    const peer = conn || this.peer.connect(id)\n    const connection = this._connections[id] = new Connection(this.docSet, msg => {\n      peer.send(this._encode(msg))\n    })\n    peer.on('disconnected', () => {\n      connection.close()\n      delete this._connections[id]\n    })\n    connection.open()\n    return peer\n  }\n\n  public get<T>(id: string): Doc<T> {\n    return this.docSet.getDoc(id) || init(this._actorId)\n  }\n\n  public select<T>(id: string): (changeMethod: AutomergeUpdateMethod, ...args: any[]) => Doc<T> {\n    return (changeMethod: Function, ...args: any[]): Doc<T> => {\n      const newDoc = changeMethod(this.get(id), ...args)\n      this.docSet.setDoc(id, newDoc)\n      return newDoc\n    }\n  }\n\n  public subscribe<T>(idOrSetHandler: string | DocSetHandler<T>, callback?: ChangeFn<T>): () => void {\n    if (typeof idOrSetHandler === 'function') {\n      this.docSet.registerHandler(idOrSetHandler)\n      return () => this.docSet.unregisterHandler(idOrSetHandler)\n    }\n    if (typeof idOrSetHandler === 'string' && !!callback) {\n      const handler = (docId: string, doc: T) => {\n        if (docId === idOrSetHandler) callback(doc)\n      }\n      this.docSet.registerHandler(handler)\n      return () => this.docSet.unregisterHandler(handler)\n    }\n    return () => { }\n  }\n}\n"],"names":["constructor","actorId","config","this","_actorId","peer","Peer","docSet","DocSet","_encode","encode","JSON","stringify","_decode","decode","parse","on","conn","_connections","connect","msg","receiveMsg","id","connections","connection","Connection","send","close","open","get","getDoc","init","select","changeMethod","args","newDoc","setDoc","subscribe","idOrSetHandler","callback","registerHandler","unregisterHandler","handler","docId","doc"],"mappings":"wGAqBEA,YAAYC,EAAiBC,EAAsB,IAL3CC,kBAAkD,GAMxDA,KAAKC,SAAWH,EAChBE,KAAKE,KAAOH,EAAOG,MAAQ,IAAIC,EAAKH,KAAKC,UACzCD,KAAKI,OAASL,EAAOK,QAAU,IAAIC,EACnCL,KAAKM,QAAUP,EAAOQ,QAAUC,KAAKC,UACrCT,KAAKU,QAAUX,EAAOY,QAAUH,KAAKI,MACrCZ,KAAKE,KAAKW,GAAG,aAAcC,IACrBd,KAAKe,aAAaD,EAAKZ,OAAOF,KAAKgB,QAAQF,EAAKZ,MACpDY,EAAKD,GAAG,OAAQI,IACdjB,KAAKe,aAAaD,EAAKZ,MAAMgB,WAAWlB,KAAKU,QAAQO,QAKpDD,QAAQG,EAAYL,GACzB,GAAId,KAAKe,aAAaI,GAAK,YAAYjB,KAAKkB,YAAYD,GACxD,MAAMjB,EAAOY,GAAQd,KAAKE,KAAKc,QAAQG,GACjCE,EAAarB,KAAKe,aAAaI,GAAM,IAAIG,EAAWtB,KAAKI,OAAQa,IACrEf,EAAKqB,KAAKvB,KAAKM,QAAQW,MAOzB,OALAf,EAAKW,GAAG,eAAgB,KACtBQ,EAAWG,oBACCT,aAAaI,KAE3BE,EAAWI,OACJvB,EAGFwB,IAAOP,GACZ,YAAYf,OAAOuB,OAAOR,IAAOS,EAAK5B,KAAKC,UAGtC4B,OAAUV,GACf,MAAO,CAACW,KAA2BC,KACjC,MAAMC,EAASF,EAAa9B,KAAK0B,IAAIP,MAAQY,GAE7C,OADA/B,KAAKI,OAAO6B,OAAOd,EAAIa,GAChBA,GAIJE,UAAaC,EAA2CC,GAC7D,GAA8B,mBAAnBD,EAET,OADAnC,KAAKI,OAAOiC,gBAAgBF,GACrB,IAAMnC,KAAKI,OAAOkC,kBAAkBH,GAE7C,GAA8B,iBAAnBA,GAAiCC,EAAU,CACpD,MAAMG,EAAU,CAACC,EAAeC,KAC1BD,IAAUL,GAAgBC,EAASK,IAGzC,OADAzC,KAAKI,OAAOiC,gBAAgBE,GACrB,IAAMvC,KAAKI,OAAOkC,kBAAkBC,GAE7C,MAAO"}